name: Update Subscription

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

env:
  NUM_RUNNERS: 4

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.split.outputs.matrix }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Fetch Raw Configs
        run: |
          curl -L -o raw.txt "https://raw.githubusercontent.com/barry-far/V2ray-config/main/Splitted-By-Protocol/vless.txt"
          echo "âœ… Total configs fetched: $(wc -l < raw.txt)"

      - name: Remove Duplicates and Comments
        run: |
          grep -v "^#" raw.txt | grep -v "^$" | sort | uniq > unique.txt
          echo "âœ… Unique configs: $(wc -l < unique.txt)"

      - name: Split configs into chunks
        id: split
        run: |
          total_lines=$(wc -l < unique.txt)
          chunk_size=$(( ($total_lines + $NUM_RUNNERS - 1) / $NUM_RUNNERS ))
          echo "Chunk size: $chunk_size"
          matrix_json="{\"runner\":["
          for i in $(seq 1 $NUM_RUNNERS); do
            matrix_json+="\"$i\""
            [ $i -lt $NUM_RUNNERS ] && matrix_json+=","
          done
          matrix_json+="]}"
          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
          mkdir -p share
          cp unique.txt share/unique.txt

      - name: Upload unique.txt
        uses: actions/upload-artifact@v4
        with:
          name: shared-unique
          path: share/

  test:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download unique.txt
        uses: actions/download-artifact@v4
        with:
          name: shared-unique
          path: ./

      - name: Get my chunk of configs
        run: |
          total_lines=$(wc -l < unique.txt)
          chunk_size=$(( ($total_lines + $NUM_RUNNERS - 1) / $NUM_RUNNERS ))
          start_line=$(( (${{ matrix.runner }} - 1) * $chunk_size + 1 ))
          end_line=$(( ${{ matrix.runner }} * $chunk_size ))
          sed -n "${start_line},${end_line}p" unique.txt > my_chunk.txt
          echo "ðŸ”¹ Runner ${{ matrix.runner }} testing $(wc -l < my_chunk.txt) configs"

      - name: Setup Xray-core
        run: |
          wget -q https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
          unzip -q Xray-linux-64.zip -d xray-core
          chmod +x xray-core/xray
          echo "Xray version: $(./xray-core/xray --version)"

      - name: Install dependencies
        run: pip install requests

      - name: Test a single known config manually
        run: |
          # ÛŒÚ© Ù„ÛŒÙ†Ú© Ù†Ù…ÙˆÙ†Ù‡ Ø§Ø² my_chunk.txt Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ (Ø§ÙˆÙ„ÛŒÙ† Ù„Ø§ÛŒÙ†)
          head -1 my_chunk.txt > sample.txt
          SAMPLE_CONFIG=$(cat sample.txt)
          echo "Testing sample config: $SAMPLE_CONFIG"
          python3 -c "
import subprocess, time, json, os, socket, urllib.parse, sys, requests

XRAY_PATH = './xray-core/xray'
TEST_URL = 'http://cp.cloudflare.com/generate_204'
socks_port = 12345

def extract_host_port(vless_url):
    try:
        parsed = urllib.parse.urlparse(vless_url)
        netloc = parsed.netloc.split('@')[-1].split('/')[0].split('?')[0]
        if netloc.startswith('['):
            bracket_end = netloc.find(']')
            if bracket_end == -1: return None
            host = netloc[1:bracket_end]
            remainder = netloc[bracket_end+1:]
            if remainder.startswith(':'): port = int(remainder[1:])
            else: port = 443
        else:
            if ':' in netloc:
                host, port_str = netloc.split(':', 1)
                port = int(port_str)
            else:
                host = netloc
                port = 443
        return host, port
    except:
        return None

line = '$SAMPLE_CONFIG'
hp = extract_host_port(line)
if not hp:
    print('Failed to extract host/port')
    sys.exit(1)
print(f'Host: {hp[0]}, Port: {hp[1]}')

# Ø³Ø§Ø®Øª Ú©Ø§Ù†ÙÛŒÚ¯ Ø³Ø§Ø¯Ù‡ (ÙÙ‚Ø· VLESS Ø®Ø§Ù… Ø¨Ø¯ÙˆÙ† streamSettings Ø®Ø§Øµ)
config = {
    'log': {'loglevel': 'none'},
    'inbounds': [{
        'port': socks_port,
        'listen': '127.0.0.1',
        'protocol': 'socks',
        'settings': {'auth': 'noauth', 'udp': True}
    }],
    'outbounds': [{
        'protocol': 'vless',
        'settings': {
            'vnext': [{
                'address': hp[0],
                'port': hp[1],
                'users': [{'id': line.split('://')[1].split('@')[0], 'encryption': 'none'}]
            }]
        }
    }]
}
with open('sample_config.json', 'w') as f:
    json.dump(config, f)

# Ø§Ø¬Ø±Ø§ÛŒ Xray
proc = subprocess.Popen([XRAY_PATH, '-c', 'sample_config.json'], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
time.sleep(2)  # ØµØ¨Ø± Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ù„Ø§ Ø¢Ù…Ø¯Ù† Ù¾Ø±ÙˆÚ©Ø³ÛŒ

try:
    proxies = {'http': f'socks5://127.0.0.1:{socks_port}', 'https': f'socks5://127.0.0.1:{socks_port}'}
    start = time.time()
    r = requests.get(TEST_URL, proxies=proxies, timeout=10)
    latency = (time.time() - start) * 1000
    if r.status_code == 204:
        print(f'âœ… SUCCESS! Latency: {latency:.0f}ms')
    else:
        print(f'âŒ Failed: HTTP {r.status_code}')
except Exception as e:
    print(f'âŒ Exception: {e}')
finally:
    proc.terminate()
    time.sleep(1)
    proc.kill()
    os.remove('sample_config.json')
"

      - name: Test and Filter Configs (Real Delay with Xray)
        run: |
          python3 test_configs_xray_final.py my_chunk.txt result_${{ matrix.runner }}.txt

      - name: Upload result chunk
        uses: actions/upload-artifact@v4
        with:
          name: result-chunk-${{ matrix.runner }}
          path: result_${{ matrix.runner }}.txt

  merge:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download all result chunks
        uses: actions/download-artifact@v4
        with:
          pattern: result-chunk-*
          path: chunks/
          merge-multiple: true

      - name: Merge results
        run: |
          if ls chunks/result_*.txt 1> /dev/null 2>&1; then
            cat chunks/result_*.txt > subscription.txt
            echo "âœ… Total valid configs: $(wc -l < subscription.txt)"
          else
            echo "âš ï¸ No result files found!"
            > subscription.txt
          fi

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add subscription.txt
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update subscription"
            git pull --rebase origin main
            git push origin main
          fi
